# Review Normalizer Service

FastAPI service for normalizing Hostaway reviews and enriching review text with issue tags.

## Local Development

### Setup

```bash
# Install dependencies
pip install -r requirements.txt
```

### Run the Service

```bash
# Start the server with hot reload
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

The API will be available at `http://localhost:8000`

Interactive API docs (Swagger UI): `http://localhost:8000/docs`

## API Endpoints

### Health Check

```bash
curl http://localhost:8000/health
```

**Response:**
```json
{
  "ok": true
}
```

### Normalize Hostaway Reviews

Converts raw Hostaway review data to normalized format.

```bash
curl -X POST http://localhost:8000/normalize/hostaway \
  -H "Content-Type: application/json" \
  -d '{
    "status": "success",
    "result": [
      {
        "id": 12345,
        "type": "guest",
        "status": "published",
        "rating": 4.5,
        "publicReview": "Great place, very clean and comfortable!",
        "reviewCategory": [
          {
            "category": "cleanliness",
            "rating": 5
          },
          {
            "category": "respect_house_rules",
            "rating": 4
          }
        ],
        "submittedAt": "2024-12-15 14:30:45",
        "guestName": "John Doe",
        "listingName": "Cozy Downtown Apartment"
      }
    ]
  }'
```

**Response:**
```json
{
  "normalized": [
    {
      "reviewId": "hostaway:12345",
      "source": "hostaway",
      "listingId": "cozy-downtown-apartment",
      "listingName": "Cozy Downtown Apartment",
      "type": "guest",
      "status": "published",
      "submittedAtISO": "2024-12-15T14:30:45.000Z",
      "guestName": "John Doe",
      "publicReview": "Great place, very clean and comfortable!",
      "overallRating": 4.5,
      "categories": [
        {
          "key": "cleanliness",
          "label": "Cleanliness",
          "rating": 5
        },
        {
          "key": "respect_house_rules",
          "label": "Respect house rules",
          "rating": 4
        }
      ]
    }
  ]
}
```

### Enrich Review with Issue Tags

Extracts issue tags from review text using keyword matching.

```bash
curl -X POST http://localhost:8000/enrich/issues \
  -H "Content-Type: application/json" \
  -d '{
    "text": "The wifi was not working and the apartment was very noisy at night. Also had trouble with the check-in process."
  }'
```

**Response:**
```json
{
  "tags": ["wifi", "noise", "check-in"]
}
```

### Available Issue Tags

- `wifi` - Internet connectivity issues
- `noise` - Noise-related complaints  
- `cleanliness` - Cleanliness concerns
- `check-in` - Check-in/access issues
- `heating` - Temperature/climate control issues
- `communication` - Host communication problems

## Notes

- All dates from Hostaway are treated as UTC to avoid timezone inconsistencies
- Listing IDs are generated by slugifying the listing name
- Overall rating is calculated from category averages if not explicitly provided
- Category labels are formatted from underscore_case to readable "Title case"
