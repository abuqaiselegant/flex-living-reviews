service: flex-living-reviews

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  
  environment:
    DATABASE_URL: ${env:DATABASE_URL}
    APPROVALS_TABLE: ${self:custom.approvalsTableName}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - !GetAtt ReviewApprovalsTable.Arn
            - !Join ['/', [!GetAtt ReviewApprovalsTable.Arn, 'index/*']]
  
  httpApi:
    cors:
      allowedOrigins: ['*']
      allowedHeaders: ['Content-Type', 'X-Amz-Date', 'Authorization', 'X-Api-Key', 'X-Amz-Security-Token']
      allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']

custom:
  approvalsTableName: ${self:service}-${self:provider.stage}-approvals

package:
  individually: false
  patterns:
    - '!.git/**'
    - '!.vscode/**'
    - '!tests/**'
    - '!*.md'
    - '!infra/**'
    - 'apps/api/**'
    - 'packages/**'
    - 'node_modules/**'

functions:
  normalizer:
    handler: main.handler
    runtime: python3.11
    timeout: 30
    memorySize: 512
    package:
      artifact: ../apps/normalizer/normalizer.zip
    events:
      - httpApi:
          path: /normalize/{proxy+}
          method: ANY
      - httpApi:
          path: /health
          method: GET

  reviewsHostaway:
    handler: apps/api/src/handlers/reviewsHostaway.handler
    timeout: 30
    memorySize: 512
    environment:
      NORMALIZER_URL: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
    events:
      - httpApi:
          path: /v1/reviews/hostaway
          method: GET

  approveReview:
    handler: apps/api/src/handlers/approveReview.handler
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /v1/reviews/{reviewId}/approve
          method: POST

  publicReviews:
    handler: apps/api/src/handlers/publicReviews.handler
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /v1/public/listings/{listingId}/reviews
          method: GET

  publicListings:
    handler: apps/api/src/handlers/publicListings.handler
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /v1/public/listings
          method: GET

  dashboardListings:
    handler: apps/api/src/handlers/dashboardListings.handler
    timeout: 15
    memorySize: 512
    events:
      - httpApi:
          path: /v1/dashboard/listings
          method: GET

  listingApprovals:
    handler: apps/api/src/handlers/listingApprovals.handler
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /v1/dashboard/listings/{listingId}/approvals
          method: GET

resources:
  Resources:
    ReviewApprovalsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.approvalsTableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: listingId
            AttributeType: S
          - AttributeName: reviewId
            AttributeType: S
        KeySchema:
          - AttributeName: listingId
            KeyType: HASH
          - AttributeName: reviewId
            KeyType: RANGE

  Outputs:
    ApiUrl:
      Value: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
